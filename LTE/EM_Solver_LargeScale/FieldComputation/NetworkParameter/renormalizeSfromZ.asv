% refImp ...    vector of desired reference port impedances
% presImp ...   vector of present port impedances
function S = renormalizeSfromZ(Z, actualImp, desiredImp)

d = size(Z,1);

Z0 = diag(presImp .* ones(d,1));
Zref = diag(refImp .* ones(d,1));
Yref = diag(1./refImp .* ones(d,1));

Z = sqrt(Z0) * Z * sqrt(Z0);

S = sqrt(Yref) * (Z - Zref) * inv(Z + Zref) * sqrt(Zref);